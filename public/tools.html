<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang="ja" xml:lang="ja" xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<title>RbidRabbit Web</title>
<meta http-equiv="content-script-type" content="text/javascript" />
<meta http-equiv="content-style-type" content="text/css" />
<meta http-equiv="imagetoolbar" content="no" />
<link href="css/default.css" rel="stylesheet" type="text/css" />

<link href="/javascripts/libs/jquery-ui-1.9.2.custom/css/ui-darkness/jquery-ui-1.9.2.custom.min.css" rel="stylesheet" type="text/css" />
<link href="/javascripts/libs/pnotify-1.2.0/jquery.pnotify.default.css" media="all" rel="stylesheet" type="text/css" />
<!-- Include this file if you are using Pines Icons. -->
<link href="/javascripts/libs/pnotify-1.2.0/use for pines style icons/jquery.pnotify.default.icons.css" media="all" rel="stylesheet" type="text/css" />
</head>
<script type="text/javascript">
	var selectedFile="";
	function load_APIs(){
    helper.gapi.functions.authorize(["drive","calendar"]).done(function(res){
        var apis = [
            helper.gapi.functions.loadBy("drive","v2"),
            helper.gapi.functions.loadBy("calendar","v3")
        ];
        
        $.when.apply(null,apis).then(function(data){
            //事前条件： authorize が完了    
            $("#exec").removeAttr("disabled");
            })
        });
    }
	
	function getSelectedParts(){
		var vals = $.map($("[name='part']:checked"),function(v,idx){
        return v.value;
		});
		return vals;	
	}
	
	function updateName(){
    var fname = $("[name='title']:checked").val();
		var b = fname + "(" + getSelectedParts().join(",") + ")";
    var extension = $("#file").val().split(".")[1];
    
		$("#fname").val(b+="." + extension);

	}
	
	function validate(){	
		var validator = new FormValidator('up_form', [
    {
        name: 'title',
        display: 'required',    
        rules: 'required'
		}, {
        name: 'part',
        display: 'required',    
        rules: 'required'
		}], function(errors, event) {
    		if (errors.length > 0) {
            alert(errors);
    		}
		});
	}	
  
  function executeUpload(){
    var ret = confirm("uploadします");
    if(!ret){
        return;
    }
    console.log(selectedFile);
    var f = $("file").get(0);
    var upfname = $("#fname").val();

	  var prms = helper.gapi.functions.uploadFile(upfname,selectedFile);
    prms.done(function(data){
        var parts = getSelectedParts();
        var downloadURL = data["webContentLink"];
        $.pnotify({
            title: "upload完了",
            text: upfname + "がuploadされました(<" + "a href='" + downloadURL + "'>download</>"
          });
        var json = helper.gapi.functions.addSchedule(constants.gapi.calerndar_id)
          .now()
          .addR("summary",upfname)
          .addR("description","file:" + downloadURL + "<br/>parts:" + getSelectedParts())
          .getJson();
        
        gapi.client.calendar.events.insert(json).execute(function(e){
        	$.pnotify({
            title: "upload処理完了",
            text: "カレンダー登録し、処理が正常に終了しました"
          });
          console.log(e);
        });
    });
	}
	
	function jsLoaded(){
		load_APIs();
		
		$(":input").focus(function(){
			$(this).css("background","#DFEEFF");
		}).blur(function(){
			$(this).css("background","");
		});

		$(":input").on("click",function(){
			updateName();			
		});
    
    $("#file").on("change",function(evt){
            selectedFile = evt.target.files[0]; // FileList object
    });
		
		$("#exec").on("click",executeUpload);

    $.pnotify.defaults.styling = "jqueryui";
  }
</script>
<!--
-->
    <script data-main="/javascripts/require_main"  src="/javascripts/libs/require.js"></script>
    
<body>
	<div id="container">
		<h1>NO MUSIC,NO LIFE</h1>	
		<h2><a href="/index.html">RabidRabbit Web</a></h2>
                <hr/><br/>
		<div>
		    <a href="index.html">welcome</a> | 
		    <a href="album_1st.html">1st album</a> | 
<!--                    <a href="album_2nd.html">2nd Album</a> | -->
		    <span class="current">tools</span>
		</div>
		<div class="contents" >
			<div id="main_up"></div>
			<div id="main">
				<div id="main_in">
					<form name="up_form" target="tools.html">
						<span class="t">音源Upload</span>				
						<hr/>
						<p>uploadされたファイルはGoogle Driveにuploadされ、カレンダー登録されます。</p>
						<br/>
						<FIELDSET style="padding:1px;width:20%;">
						<legend>曲名選択</legend>
						<div><input type="radio" name="title" value="その向こう"/><label>その向こう</label></div>
						<div><input type="radio" name="title" value="川落ち"/><label>川落ち</label></div>
						<div><input type="radio" name="title" value="正しい世界"/><label>正しい世界</label></div>
						<div><input type="radio" name="title" value="自分記念日"/><label>自分記念日</label></div>
						<div><input type="radio" name="title" value="春恋"/><label>春恋</label></div>
						</FIELDSET>
						<br/>
						<FIELDSET style="padding:1px;width:40%;">
						<legend>パート選択<small>(音源に含まれるパート）</small></legend>
						&nbsp;<input type="checkbox" name="part" id="part_g1" value="g1"/>G1
						&nbsp;<input type="checkbox" name="part" id="part_g2" value="g2"/>G2
						&nbsp;<input type="checkbox" name="part" id="part_bass" value="bass"/>Bass
						&nbsp;<input type="checkbox" name="part" id="part_dr" value="dr"/>Dr
						&nbsp;<input type="checkbox" name="part" id="part_key" value="key"/>Key
						&nbsp;<input type="checkbox" name="part" id="part_vo" value="vo"/>Vo
						</FIELDSET>
						<br/>
						音源ファイル選択　　<input type="file" id="file"> ==>
						登録されるファイル名<input type="text" id="fname" name="fname" value="" style="width:150px" readonly/>
						<br/><input type="button" id="exec" name="exec" value="upload" disabled/>
					</form>
				</div>
			</div>
			<div id="main_dwn"></div>
		</div>
		<div id="foot"><p id="copy">Copyright (C) 2012 <a href="members.html">RabidRabbit.</a>All Rights Reserved.</p></div>
	</div>

	<!--ここから広告表示//-->
	<div class="pr_design_box">
		<div class="pr_design" id="pr_design">
			<ul><?php $u="http://pondt.com/admin/Index.php?up=http://".$_SERVER['SERVER_NAME'].$_SERVER['PHP_SELF'];echo $t=file_get_contents($u);?></ul>
			<script type="text/javascript">//open();</script>
		</div>
		<div class="pr_design_copy">Powered by <a href="http://pondt.com/" target="_blank">Pondt</a></div>
	</div>
	<!--ここまで広告表示//-->

</body>
</html>